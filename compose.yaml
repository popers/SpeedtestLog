services:
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    container_name: speedtest-backend
    ports:
      - 8000:8000
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - AUTH_ENABLED=${AUTH_ENABLED}
      - APP_USERNAME=${APP_USERNAME}
      - APP_PASSWORD=${APP_PASSWORD}
      - SESSION_SECRET=${SESSION_SECRET}
      - APP_LANG=${APP_LANG}
      - OOKLA_EULA_GDPR=true
      - TZ=Europe/Amsterdam
    volumes:
      - ./backend/data:/app/data
    depends_on:
      db:
        condition: service_healthy
    # --- NOWE: Healthcheck dla Backendu ---
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8000/api/auth-status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  db:
    image: mariadb:10.11
    container_name: speedtest-mariadb
    environment:
      - MARIADB_DATABASE=${DB_DATABASE}
      - MARIADB_USER=${DB_USERNAME}
      - MARIADB_PASSWORD=${DB_PASSWORD}
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    volumes:
      - speedtest-db-data:/var/lib/mysql
      - ./backend/data/logs:/var/log/mysql
    # Healthcheck bazy danych (był już wcześniej, jest poprawny)
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - -h
        - localhost
        - -u
        - ${DB_USERNAME}
        - -p${DB_PASSWORD}
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    entrypoint: |
      sh -c "
        echo 'Przygotowywanie uprawnien logow...'
        mkdir -p /var/log/mysql
        chmod 777 /var/log/mysql
        touch /var/log/mysql/slow-query.log
        chmod 666 /var/log/mysql/slow-query.log
        
        exec /usr/local/bin/docker-entrypoint.sh mariadbd
      "
    command:
      - --slow_query_log=1
      - --slow_query_log_file=/var/log/mysql/slow-query.log
      - --long_query_time=2
      - --innodb-use-native-aio=0

volumes:
  speedtest-db-data: null
networks: {}